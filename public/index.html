<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ACall</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f3f4f6;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    h1 {
      margin-bottom: 10px;
    }
    .card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      width: 320px;
    }
    .row { margin: 10px 0; }
    input, button {
      padding: 8px;
      margin: 5px 0;
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    button {
      cursor: pointer;
      background: #3b82f6;
      color: white;
      border: none;
    }
    button:disabled { background: #9ca3af; }
    ul { list-style: none; padding: 0; }
    li {
      background: #e5e7eb;
      margin: 5px 0;
      padding: 8px;
      border-radius: 6px;
      cursor: pointer;
    }
    li:hover { background: #d1d5db; }
    .small { font-size: 0.9em; color: #555; }
  </style>
</head>
<body>
  <h1>ACall</h1>
  <div class="card">
    <div class="row">
      <input id="username" placeholder="Enter name"/>
      <button id="joinBtn">Join</button>
    </div>

    <div class="row">
      <button id="toggleMic" disabled>Mute Mic</button>
    </div>

    <div class="row">
      <label class="small">Volume:</label>
      <input type="range" id="volume" min="0" max="5" step="0.1" value="1"/>
    </div>

    <div class="row">
      <label><input type="checkbox" id="monitorSelf"> Monitor my voice</label>
    </div>

    <h3>Online Users</h3>
    <ul id="userList"></ul>
  </div>

  <!-- 隐藏的 audio 用于远端和本地监听 -->
  <audio id="remoteAudio" autoplay></audio>
  <audio id="localMonitor" autoplay muted></audio>

  <script>
    const ws = new WebSocket(`wss://${location.host}`);
    let pc, localStream;
    const remoteAudio = document.getElementById('remoteAudio');
    const localMonitor = document.getElementById('localMonitor');
    const volumeControl = document.getElementById('volume');
    const toggleMicBtn = document.getElementById('toggleMic');
    const userList = document.getElementById('userList');
    const usernameInput = document.getElementById('username');
    const joinBtn = document.getElementById('joinBtn');
    const monitorSelf = document.getElementById('monitorSelf');
    let micEnabled = true;
    let username = '';

    // Web Audio API
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const remoteGain = audioCtx.createGain();
    const remoteStreamDest = audioCtx.createMediaStreamDestination();
    remoteAudio.srcObject = remoteStreamDest.stream;

    joinBtn.onclick = async () => {
      username = usernameInput.value.trim();
      if (!username) return alert("Enter name");
      ws.send(JSON.stringify({ type: 'join', username }));
      joinBtn.disabled = true;
      usernameInput.disabled = true;
      toggleMicBtn.disabled = false;

      localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      localMonitor.srcObject = null; // 默认不监听
    };

    toggleMicBtn.onclick = () => {
      micEnabled = !micEnabled;
      localStream.getTracks().forEach(track => track.enabled = micEnabled);
      toggleMicBtn.textContent = micEnabled ? "Mute Mic" : "Unmute Mic";
    };

    volumeControl.oninput = () => {
      remoteGain.gain.value = parseFloat(volumeControl.value);
      if (localMonitor.srcObject) {
        localMonitor.volume = parseFloat(volumeControl.value);
      }
    };

    monitorSelf.onchange = () => {
      if (monitorSelf.checked) {
        localMonitor.srcObject = localStream;
        localMonitor.muted = false;
      } else {
        localMonitor.srcObject = null;
      }
    };

    ws.onmessage = async (event) => {
      const msg = JSON.parse(event.data);

      if (msg.type === 'users') {
        userList.innerHTML = '';
        msg.users.forEach(u => {
          if (u === username) return;
          const li = document.createElement('li');
          li.textContent = u;
          li.onclick = () => startCall(u);
          userList.appendChild(li);
        });
      }

      if (msg.type === 'offer') {
        await createPeer();
        await pc.setRemoteDescription(new RTCSessionDescription(msg.offer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        ws.send(JSON.stringify({ type: 'answer', answer, target: msg.from }));
      }

      if (msg.type === 'answer') {
        await pc.setRemoteDescription(new RTCSessionDescription(msg.answer));
      }

      if (msg.type === 'candidate') {
        await pc.addIceCandidate(new RTCIceCandidate(msg.candidate));
      }
    };

    async function createPeer() {
      pc = new RTCPeerConnection();
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      pc.onicecandidate = (e) => {
        if (e.candidate) {
          ws.send(JSON.stringify({ type: 'candidate', candidate: e.candidate, target: pc.targetUser }));
        }
      };
      pc.ontrack = (e) => {
        const source = audioCtx.createMediaStreamSource(e.streams[0]);
        source.connect(remoteGain);
        remoteGain.connect(remoteStreamDest);
      };
    }

    async function startCall(targetUser) {
      await createPeer();
      pc.targetUser = targetUser;
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      ws.send(JSON.stringify({ type: 'offer', offer, target: targetUser }));
    }

    // 心跳，保持 Render 醒着
    setInterval(() => {
      fetch("/ping").catch(() => {});
    }, 25000);
  </script>
</body>
</html>
