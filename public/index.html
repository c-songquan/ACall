<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ACall</title>
  <style>
    body { font-family: Arial; padding: 20px; background: #f9f9f9; }
    #login { margin-bottom: 20px; }
    #users { margin: 10px 0; padding: 0; list-style: none; }
    #users li { padding: 4px 8px; background: #eee; margin: 2px 0; border-radius: 4px; }
    #volumeBar { width: 200px; height: 20px; background: #ddd; margin-top: 10px; border-radius: 4px; }
    #volumeFill { height: 100%; width: 0; background: green; border-radius: 4px; }
    button { margin: 5px; padding: 6px 12px; cursor: pointer; }
  </style>
</head>
<body>
  <div id="login">
    <input id="username" placeholder="输入用户名">
    <button onclick="login()">进入</button>
  </div>

  <div id="main" style="display:none;">
    <h3>在线用户:</h3>
    <ul id="users"></ul>

    <button id="micBtn" onclick="toggleMic()">关闭麦克风</button>
    <div id="volumeBar"><div id="volumeFill"></div></div>
  </div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    let socket;
    let localStream;
    let micOn = true;
    let username = "";

    // 自动连接 + 重连
    function connectSocket() {
      socket = io({
        reconnection: true,
        reconnectionAttempts: Infinity,
        reconnectionDelay: 2000
      });

      socket.on("connect", () => {
        console.log("✅ 已连接");
        if (username) socket.emit("login", username);
      });

      socket.on("disconnect", () => {
        console.log("❌ 断开，等待重连...");
      });

      socket.on("userlist", (list) => {
        const ul = document.getElementById("users");
        ul.innerHTML = "";
        list.forEach(u => {
          const li = document.createElement("li");
          li.innerText = u;
          ul.appendChild(li);
        });
      });
    }

    function login() {
      username = document.getElementById("username").value.trim();
      if (!username) {
        alert("请输入用户名");
        return;
      }
      socket.emit("login", username);
      document.getElementById("login").style.display = "none";
      document.getElementById("main").style.display = "block";
      startAudio();
    }

    async function startAudio() {
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const audioContext = new AudioContext();
      const source = audioContext.createMediaStreamSource(localStream);
      const analyser = audioContext.createAnalyser();
      source.connect(analyser);
      const data = new Uint8Array(analyser.frequencyBinCount);

      function draw() {
        analyser.getByteFrequencyData(data);
        let volume = data.reduce((a,b)=>a+b) / data.length;
        document.getElementById("volumeFill").style.width = Math.min(volume,200) + "px";
        requestAnimationFrame(draw);
      }
      draw();
    }

    function toggleMic() {
      if (localStream) {
        localStream.getTracks().forEach(track => track.enabled = !track.enabled);
        micOn = !micOn;
        document.getElementById("micBtn").innerText = micOn ? "关闭麦克风" : "打开麦克风";
      }
    }

    // 防止 Render 休眠：定时 ping
    setInterval(() => {
      fetch("/ping").catch(() => {});
    }, 25000);

    // 启动
    connectSocket();
  </script>
</body>
</html>
